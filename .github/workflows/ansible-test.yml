name: CI
on:
#- pull_request
- push

jobs:
#  sanity:
#    runs-on: ubuntu-latest
#    steps:
#
#      - name: Check out code
#        uses: actions/checkout@master
#        #with:
#        #  path: ansible_collections/community/zabbix
#
#      - name: Set up Python 3.6
#        uses: actions/setup-python@v1
#        with:
#          python-version: 3.6
#
#      - name: Install ansible-base
#        run: pip install git+https://github.com/ansible-collection-migration/ansible-base.git --disable-pip-version-check
#
#      - name: Run sanity tests
#        run: ansible-test sanity --docker -v --color --python 3.6

#  integration:
#    runs-on: ubuntu-latest
#    steps:
#
#      - name: Check out code
#        uses: actions/checkout@master
#        with:
#          path: ansible_collections/community/zabbix
#
#      - name: Set up Python 3.6
#        uses: actions/setup-python@v1
#        with:
#          python-version: 3.6
#
#      - name: Install dependencies
#        run: pip install docker-compose zabbix-api
#
#      - name: zabbix container server provisioning
#        run: docker-compose -f ansible_collections/community/zabbix/docker-compose.yml up -d
#
#      - name: Install ansible-base
#        run: pip install git+https://github.com/ansible-collection-migration/ansible-base.git --disable-pip-version-check
#
#      - name: run integration test
#        run: |
#          cd ansible_collections/community/zabbix
#          ansible-test integration -v --color --retry-on-error --continue-on-error --diff

  runs-on: ubuntu-latest
  job1:
    steps:
      - name: create container network
        run: docker network create --subnet=192.168.0.0/24 zbx_nw

  integration:
    #runs-on: ubuntu-latest
    needs: job1
    container:
      image: zabbix/zabbix-web-nginx-mysql:ubuntu-4.4.0
      env:
        DB_SERVER_HOST: "192.168.0.3"
        MYSQL_USER: "zabbix"
        MYSQL_PASSWORD: "zabbix"
        MYSQL_DATABASE: "zabbix"
        MYSQL_ROOT_PASSWORD: "zabbix"
        ZBX_SERVER_HOST: "zabbix44-server"
      ports:
        - 8030:80
      options: --name zabbix44-web --net zbx_nw --ip 192.168.0.2

    services:
      zabbix44-db:
        image: mysql:5.7
        env:
          MYSQL_DATABASE: "zabbix"
          MYSQL_USER: "zabbix"
          MYSQL_PASSWORD: "zabbix"
          MYSQL_ROOT_PASSWORD: "zabbix"
        options: --name zabbix44-db --net zbx_nw --ip 192.168.0.3

      zabbix44-server:
        image: zabbix/zabbix-server-mysql:ubuntu-4.4.0
        env:
          DB_SERVER_HOST: "192.168.0.3"
          MYSQL_USER: "zabbix"
          MYSQL_PASSWORD: "zabbix"
          MYSQL_DATABASE: "zabbix"
          MYSQL_ROOT_PASSWORD: "zabbix"
        options: --name zabbix44-server --net zbx_nw --ip 192.168.0.4

    steps:

      - name: Check out code
        uses: actions/checkout@master
        with:
          path: ansible_collections/community/zabbix

      - name: Set up Python 3.6
        uses: actions/setup-python@v1
        with:
          python-version: 3.6

      - name: Install dependencies
        run: pip install docker-compose zabbix-api
